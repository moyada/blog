---
title: 数据库设计
categories: 数据库
date: 2017-03-16 18:16:35
tags:
---

# 分表方法
在数据库表使用过程中，为了减小数据库服务器的负担、缩短查询时间，常常会考虑做分表设计。分表分两种，一种是纵向分表（将本来可以在同一个表的内容，人为划分存储在为多个不同结构的表）和横向分表（把大的表结构，横向切割为同样结构的不同表）。

其中，纵向分表常见的方式有根据活跃度分表、根据重要性分表等。其主要解决问题如下：

表与表之间资源争用问题；
锁争用机率小；
实现核心与非核心的分级存储，如UDB登陆库拆分成一级二级三级库；
解决了数据库同步压力问题。
横向分表是指根据某些特定的规则来划分大数据量表，如根据时间分表。其主要解决问题如下：

单表过大造成的性能问题；
单表过大造成的单服务器空间问题。

# 设计
1. 使用明确、统一的标明和列名，例如 School, SchoolCourse, CourceID。
2. 数据表名使用单数而不是复数，例如 StudentCourse，而不是StudentCourses。 
3. 数据表名不要使用空格。 
4. 数据表名不要使用不必要的前缀或者后缀，例如使用School，而不是TblSchool，或者SchoolTable等等。 
5. 数据库中的密码要加密，到应用中再解密。 （其实就是散列存储、单向加密）
6. 使用整数作为ID字段，也许现在没有这个必要，但是将来需要，例如关联表，索引等等。
7. 使用整数字段做索引，否则会带来很大的性能问题 。
8. 使用 bit 作为布尔字段，使用整数或者varcha是浪费。同时，这类字段应该以“Is”开头。 
9. 要经过认证才能访问数据库，不要给每一个用户管理员权限。 
10. 尽量避免使用“select *”，而使用“select [required_column_list]”以获得更好的性能。
11. 假如程序代码比较复杂，使用ORM框架，例如hibernate，iBatis。ORM框架的性能问题可以通过详细的配置去解决。 
12. 分割不常使用的数据表到不同的物理存储以获得更好的性能。 
13. 对于关键数据库，使用安全备份系统，例如集群，同步等等。 
14. 使用外键，非空等限制来保证数据的完整性，不要把所有的东西都扔给程序。 
15. 缺乏数据库文档是致命的。你应该为你的数据库设计写文档，包括触发器、存储过程和其他脚本。 
16. 对于经常使用的查询和大型数据表，要使用索引。数据分析工具可以帮助你决定如何建立索引。 
17. 数据库服务器和网页服务器应该放在不同的机器上。这回提高安全性，并减轻CPU压力。 
18. Image和blob字段不应该定义在常用的数据表中，否则会影响性能。 
19. 范式（Normalization）要按照要求使用以提高性能。Normalization做的不够会导致数据冗余，而过度Normalization 会导致太多的join和数据表，这两种情况都会影响性能。 
20. 多花点时间在数据库设计上，否则你将来会付出加倍的时间来偿还。

# 索引
少建索引或不建索引。这个问题最突出，建议建表时 DBA 可以一起协助把关。
索引滥用。滥用索引将导致写请求变慢，拖慢整体数据库的响应速度（5.5 以下的 mysql 只能用到一个索引)。
从不考虑联合索引。实际上联合索引的效率往往要比单列索引的效率更高。
非最优列选择。低选择性的字段不适合建单列索引，如 status 类型的字段。

# 优化
字段类型转换导致不用索引，如字符串类型的不用引号，数字类型的用引号等，这有可能会用不到索引导致全表扫描；
mysql 不支持函数转换，所以字段前面不能加函数，否则这将用不到索引；
不要在字段前面加减运算；
字符串比较长的可以考虑索引一部份减少索引文件大小，提高写入效率；
like % 在前面用不到索引；
根据联合索引的第二个及以后的字段单独查询用不到索引；
不要使用 select *；
排序请尽量使用升序 ;
or 的查询尽量用 union 代替 （Innodb）；
复合索引高选择性的字段排在前面；
order by / group by 字段包括在索引当中减少排序，效率会更高。
除了上述索引使用规则外，SQL 编写时还需要特别注意一下几点：

尽量规避大事务的 SQL，大事务的 SQL 会影响数据库的并发性能及主从同步；
分页语句 limit 的问题；
删除表所有记录请用 truncate，不要用 delete；
不让 mysql 干多余的事情，如计算；
输写 SQL 带字段，以防止后面表变更带来的问题，性能也是比较优的 ( 涉及到数据字典解析，请自行查询资料)；
在 Innodb上用 select count(*)，因为 Innodb 会存储统计信息；
慎用 Oder by rand()。

# 分析诊断工具
mysqldumpslow
mysql profile
mysql explain

